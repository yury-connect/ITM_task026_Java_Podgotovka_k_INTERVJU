## –ó–∞–¥–∞—á–∞ ‚Ññ 4:

---
**–î–∞–Ω–∞ —Å—Ö–µ–º–∞ –ë–î**

![–°—Ö–µ–º–∞|500](_Attachments_Task4/shema_BD.png)


–£ –∫–ª–∏–µ–Ω—Ç–∞ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –ª–∏—Ü–µ–≤—ã—Ö —Å—á–µ—Ç–æ–≤. –ü–æ –ª–∏—Ü–µ–≤–æ–º—É —Å—á—ë—Ç—É –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å
—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–ø–∏—Å–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞, –æ–ø–∏—Å–∞–Ω–∏–µ –µ–≥–æ
–ª–∏—Ü–µ–≤–æ–≥–æ —Å—á—ë—Ç–∞ –∏ —Å—Ä–µ–¥–Ω—é—é —Å—É–º–º—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É —Å—á—ë—Ç—É.

```mermaid
erDiagram
    CUSTOMER {
        int Id PK "PK"
        string Name
        string Address
    }
    ACCOUNT {
        int Id PK "PK"
        string Acc_Number
        string Description
        int Customer_Id FK "FK1"
    }
    FIN_TRANSACTION {
        int Id PK "PK"
        datetime TransactDate
        decimal Amount
        int Account_Id FK "FK1"
        string Description
    }

    CUSTOMER ||--o{ ACCOUNT : "has"
    ACCOUNT ||--o{ FIN_TRANSACTION : "has"
```

---
–°–∫—Ä–∏–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è:
![–£—Å–ª–æ–≤–∏–µ|700](_Attachments_Task4/task4_screen.png)

---
# –†–ï–®–ï–ù–ò–ï:

**–ü–æ–ª—É—á–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞, –æ–ø–∏—Å–∞–Ω–∏–µ –µ–≥–æ –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á—ë—Ç–∞ –∏ —Å—Ä–µ–¥–Ω—é—é —Å—É–º–º—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É —Å—á—ë—Ç—É.**

–°–¥–µ–ª–∞–µ–º —ç—Ç–æ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ: –æ—Ç —Å–∞–º–æ–≥–æ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–æ –±–æ–ª–µ–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∏ —á–∏—Ç–∞–µ–º–æ–≥–æ.


# SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞, –æ–ø–∏—Å–∞–Ω–∏—è –µ–≥–æ —Å—á—ë—Ç–∞ –∏ —Å—Ä–µ–¥–Ω–µ–π —Å—É–º–º—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

–î–∞–Ω–∞ —Å—Ö–µ–º–∞ –ë–î:

- `Customer(Id, Name, Address)`  
- `Account(Id, Acc_Number, Description, Customer_Id)`  
- `Fin_Transaction(Id, TransactDate, Amount, Account_Id, Description)`  

–£—Å–ª–æ–≤–∏—è:
- –£ –∫–ª–∏–µ–Ω—Ç–∞ –º–æ–∂–µ—Ç **–Ω–µ –±—ã—Ç—å –ª–∏—Ü–µ–≤—ã—Ö —Å—á–µ—Ç–æ–≤**.  
- –£ —Å—á—ë—Ç–∞ –º–æ–∂–µ—Ç **–Ω–µ –±—ã—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**.  
- –ù—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: **–∏–º—è –∫–ª–∏–µ–Ω—Ç–∞, –æ–ø–∏—Å–∞–Ω–∏–µ —Å—á—ë—Ç–∞ –∏ —Å—Ä–µ–¥–Ω—é—é —Å—É–º–º—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**.  

---
## üîπ –í–∞—Ä–∏–∞–Ω—Ç 1. –ü—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π (—Ç–æ–ª—å–∫–æ INNER JOIN)

```sql
SELECT c.Name,
       a.Description,
       AVG(t.Amount) AS AvgAmount
FROM Customer c
JOIN Account a ON a.Customer_Id = c.Id
JOIN Fin_Transaction t ON t.Account_Id = a.Id
GROUP BY c.Name, a.Description;
```
### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–æ —Å—á–µ—Ç–∞–º–∏ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.  
- –ï—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç —Å—á—ë—Ç–∞ –∏–ª–∏ —É —Å—á—ë—Ç–∞ –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚Äî –æ–Ω –ø—Ä–æ–ø–∞–¥—ë—Ç.  

---
## üîπ –í–∞—Ä–∏–∞–Ω—Ç 2. –° —É—á—ë—Ç–æ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

```sql
SELECT c.Name,
       a.Description,
       AVG(t.Amount) AS AvgAmount
FROM Customer c
JOIN Account a ON a.Customer_Id = c.Id
LEFT JOIN Fin_Transaction t ON t.Account_Id = a.Id
GROUP BY c.Name, a.Description;
```
### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
- –¢–µ–ø–µ—Ä—å –∫–ª–∏–µ–Ω—Ç —Å –ø—É—Å—Ç—ã–º —Å—á—ë—Ç–æ–º –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –≤—ã–±–æ—Ä–∫—É.  
- –ï—Å–ª–∏ —É —Å—á—ë—Ç–∞ –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚Üí `AvgAmount = NULL`.  
- –ù–æ –∫–ª–∏–µ–Ω—Ç –±–µ–∑ —Å—á—ë—Ç–∞ –≤—Å—ë –µ—â—ë –Ω–µ –ø–æ–ø–∞–¥—ë—Ç.  

---
## üîπ –í–∞—Ä–∏–∞–Ω—Ç 3. –° —É—á—ë—Ç–æ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ —Å—á–µ—Ç–æ–≤

```sql
SELECT c.Name,
       a.Description,
       AVG(t.Amount) AS AvgAmount
FROM Customer c
LEFT JOIN Account a ON a.Customer_Id = c.Id
LEFT JOIN Fin_Transaction t ON t.Account_Id = a.Id
GROUP BY c.Name, a.Description;
```
### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
- –ü–æ–ø–∞–¥–∞—é—Ç **–≤—Å–µ –∫–ª–∏–µ–Ω—Ç—ã** (–¥–∞–∂–µ –µ—Å–ª–∏ —É –Ω–∏—Ö –Ω–µ—Ç —Å—á–µ—Ç–æ–≤).  
- –ï—Å–ª–∏ –Ω–µ—Ç —Å—á—ë—Ç–∞ ‚Üí `Description = NULL`.  
- –ï—Å–ª–∏ –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚Üí `AvgAmount = NULL`.  

---
## üîπ –í–∞—Ä–∏–∞–Ω—Ç 4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (—á–µ—Ä–µ–∑ CTE)

```sql
WITH AvgTransactions AS (
    SELECT Account_Id, AVG(Amount) AS AvgAmount
    FROM Fin_Transaction
    GROUP BY Account_Id
)
SELECT c.Name,
       a.Description,
       at.AvgAmount
FROM Customer c
LEFT JOIN Account a ON a.Customer_Id = c.Id
LEFT JOIN AvgTransactions at ON at.Account_Id = a.Id;
```
### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
- –ü–æ–¥—Å—á—ë—Ç —Å—Ä–µ–¥–Ω–µ–π —Å—É–º–º—ã –≤—ã–Ω–µ—Å–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π CTE.  
- –£–ª—É—á—à–∞–µ—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.  
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Å—á–µ—Ç–æ–≤.  

---
## üîπ –í–∞—Ä–∏–∞–Ω—Ç 5. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π (—Å –∏–Ω–¥–µ–∫—Å–∞–º–∏)

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã:
```sql
CREATE INDEX idx_ft_account_amount ON Fin_Transaction(Account_Id, Amount);
CREATE INDEX idx_acc_customer ON Account(Customer_Id);
```

–¢–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å –∏–∑ **–≤–∞—Ä–∏–∞–Ω—Ç–∞ 4** –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.  

---
## ‚úÖ –ò—Ç–æ–≥
- **–í–∞—Ä–∏–∞–Ω—Ç 1** ‚Äî —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π, –Ω–æ —Ç–µ—Ä—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤/—Å—á–µ—Ç–∞ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö.  
- **–í–∞—Ä–∏–∞–Ω—Ç 3** ‚Äî –±–∞–∑–æ–≤—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–ª—É—á–∞–∏).  
- **–í–∞—Ä–∏–∞–Ω—Ç 4** ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏.  
- **–í–∞—Ä–∏–∞–Ω—Ç 5** ‚Äî —Ç–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å + –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è.  

---
