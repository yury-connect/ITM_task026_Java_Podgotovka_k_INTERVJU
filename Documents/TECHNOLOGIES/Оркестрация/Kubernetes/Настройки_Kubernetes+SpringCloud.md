### **Где и как хранятся настройки в `Kubernetes` + `Spring Cloud`**
_(Просто о сложном)_

---
### **1. `ConfigMaps`**
**Что хранится:**
- Настройки приложений (например, URL базы данных, флаги функций).    
- Параметры Spring Cloud (Eureka, Gateway).    

**Где:**
- **Внутри k8s-кластера** (как отдельный объект).    
- **В Git** (как файлы `application.yml`, которые позже превращаются в ConfigMap через Helm/Kustomize).    

**Как обновляется:**
```bash
kubectl apply -f configmap.yaml  # Вручную или через CI/CD
```
- Сервисы читают ConfigMap при старте.

**Важно:**
- ConfigMap — **не для секретов** (пароли, токены)!    
- Если поменяли ConfigMap, нужно перезапустить поды (или использовать Spring Cloud Config).    

---
### **2. `Secrets`**

**Что хранится:**
- Пароли, API-ключи, TLS-сертификаты.    
- Данные для подключения к БД (логин/пароль).    

**Где:**
- **Внутри k8s-кластера** (но в закодированном виде, base64 — это не шифрование!).    
- **В Vault** (если нужна повышенная безопасность + ротация секретов).    

**Как обновляется:**
```bash
kubectl apply -f secret.yaml  # Или через CI/CD с ограниченным доступом
```
- Сервисы получают секреты как переменные среды или через volumes.    

**Важно:**
- Base64 — это просто кодировка, **не шифрование**!    
- Для прода лучше использовать **Vault + CSI Driver**.    

---
### **3. `Spring Cloud Config`**

**Зачем:**
- Если настройки меняются часто, а перезапускать сервисы нельзя.    

**Как работает:**
1. Конфиги лежат в **Git** (например, `config-repo/service-a-dev.yml`).    
2. **Config Server** (от Spring Cloud) отдает их сервисам.    
3. Сервисы могут обновиться **без перезапуска** (через `/actuator/refresh`).    

**Плюсы:**
- Можно менять настройки **на лету**.    
- История изменений в Git.    

---
### **4. Схема хранения**

Diagram

Code

### **Когда что использовать?**

|**Тип настроек**|**Где хранить**|**Пример**|
|---|---|---|
|**Несекретные** (URL БД)|ConfigMap|`spring.datasource.url=jdbc:...`|
|**Секретные** (пароли)|Secrets (+ Vault для прода)|`db-password: xyz`|
|**Часто меняющиеся**|Spring Cloud Config + Git|Feature flags, лимиты API|

---

### **Как это выглядит в реальности?**

1. **Dev-разработчик** пушит изменения в `application-dev.yml` в Git.
    
2. **CI/CD** (например, GitLab):
    
    - Собирает ConfigMap из файла.
        
    - Обновляет его в k8s.
        
3. **Сервисы** получают новые настройки:
    
    - Через ConfigMap (если статичные).
        
    - Через Spring Cloud Config (если динамические).
        

**Ошибки, которых стоит избегать:**

- Хранить секреты в ConfigMap.
    
- Держать пароли в открытом виде даже в Secrets (лучше Vault).
    

---

**Итог:**

- **ConfigMap** — для обычных настроек.
    
- **Secrets** — для паролей (но base64 ≠ безопасность!).
    
- **Spring Cloud Config** — если надо менять настройки без перезапуска.
    
- **Vault** — для серьезных проектов с ротацией секретов.
    

Пример для собеса:

> _«Мы хранили настройки в ConfigMap (URL БД), секреты — в Secrets (но позже перенесли в Vault), а динамические конфиги — в Spring Cloud Config. Это позволяло обновлять параметры без перезапуска сервисов»_.