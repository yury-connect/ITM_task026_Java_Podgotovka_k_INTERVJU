# **Паттерн 2PC** (*Two-Phase Commit*)

**Механизм атомарных распределённых транзакций**

---
## **🔹 Суть**
2PC гарантирует, что все участники транзакции либо **фиксируют (commit)**, либо **откатывают (rollback)** изменения.  
Работает в **две фазы**:
1. **Фаза голосования (Prepare Phase)**    
    - Координатор спрашивает всех участников: _«Можете вып-ть транзакцию?»_      
    - Участники отвечают **«Да»** (готовы) или **«Нет»** (не готовы).    
2. **Фаза выполнения (Commit/Rollback Phase)**    
    - Если все голосовали «Да» → координатор командует **«Commit»**.        
    - Если хотя бы один «Нет» → **«Rollback»** для всех.        

---
## **🔹 Участники**
- **Координатор (Coordinator)** — управляет процессом (например, отдельный сервис или СУБД).    
- **Участники (Participants)** — сервисы или БД, выполняющие транзакцию.    

---
## **🔹 Плюсы и минусы**

|**Преимущества**|**Недостатки**|
|---|---|
|**Атомарность** (все или ничего)|**Блокировки** (ресурсы заморожены до конца 2PC)|
|**Строгая согласованность**|**Медленный** (из-за синхронизации)|
|Подходит для **кросс-сервисных транзакций**|**Риск зависаний** (если координатор упал)|

---
## **🔹 Когда использовать?**
- **Транзакции между разными БД** (например, PostgreSQL + MongoDB).    
- **Критичные операции** (банковские переводы, бронирования).    
- **Когда Saga не подходит** (нужна мгновенная согласованность).    

---
## **🔹 Проблемы и решения**
1. **Блокировки (Locking)**    
    - Участники блокируют данные до конца 2PC → возможны **дедлоки**.        
    - **Решение:** Таймауты на голосование.
        
2. **Отказ координатора**    
    - Если координатор упал после «Prepare», участники зависают.        
    - **Решение:**        
        - **Таймауты** (автоматический откат при долгом ожидании).            
        - **Журналирование** (координатор восстанавливает состояние после сбоя).
            
3. **Низкая производительность**    
    - **Решение:** Использовать только для коротких транзакций.        

---
## **🔹 Отличие от Saga**

|**Критерий**|**2PC**|**Saga**|
|---|---|---|
|**Согласованность**|Мгновенная (строгая)|Eventual (в конечном счёте)|
|**Блокировки**|Да (ресурсы заморожены)|Нет|
|**Производительность**|Низкая|Высокая|
|**Отказоустойчивость**|Сложная (координатор — SPOF)|Простая (децентрализовано)|

---
## **🔹 Где встречается?**
- **СУБД:** XA-транзакции (Oracle, PostgreSQL).    
- **Фреймворки:** Narayana, Atomikos (для Java).    
- **Облака:** AWS Aurora, Google Spanner.    

---
**Итог:**  
2PC — это **«жесткие» транзакции** с гарантированной атомарностью.  
Используйте, если:
- Нужна **строгая согласованность**.    
- Можно терпеть **блокировки** и низкую скорость.    

**Альтернативы:**
- **Saga** — для долгих процессов.    
- **Saga + Outbox** — для интеграции с очередями.

---
