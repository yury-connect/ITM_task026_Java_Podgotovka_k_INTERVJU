# **Шпаргалка по `ACID`**

**ACID** — это <u>набор свойств транзакций в базах данных, гарантирующих надежность операций</u>.

---
## **1. Atomicity** (*Атомарность*)
**Что значит:**  
	Транзакция выполняется **целиком** или не выполняется вообще.
**Как работает:**
- Если один шаг падает → откатываются **все изменения**.    
- Использует **журнал транзакций** (`WAL` — `Write-Ahead Log`).   
**Пример:**
```sql
BEGIN TRANSACTION;  
  UPDATE accounts SET balance = balance - 100 WHERE user_id = 1; -- Списание  
  UPDATE accounts SET balance = balance + 100 WHERE user_id = 2; -- Зачисление  
COMMIT; -- Если ошибка → ROLLBACK;  
```

## **2. Consistency (Согласованность)**
**Что значит:**  
	После транзакции БД остается в **корректном состоянии** 
		(*ограничения, ключи, триггеры*).
**Как работает:**
- Проверяет **UNIQUE**, **FOREIGN KEY**, **CHECK** перед фиксацией.    
- Если нарушено → откат.    
**Пример:**
```sql
INSERT INTO orders (user_id, product_id) VALUES (999, 1);  
-- Если user_id=999 не существует → ошибка (FOREIGN KEY) → откат.  
```

## **3. Isolation (Изолированность)**
**Что значит:**  
	Параллельные транзакции **не влияют** друг на друга.
**Уровни изоляции (от слабого к сильному):**
1. **Read Uncommitted** — Видны "грязные" чтения.    
2. **Read Committed** — Только завершенные данные (стандарт в PostgreSQL).    
3. **Repeatable Read** — Гарантирует, что повторное чтение даст те же данные.    
4. **Serializable** — Полная изоляция (как если бы транзакции шли одна за другой).   
**Проблемы без изоляции:**
- **Грязное чтение** (Dirty Read) — Чтение незафиксированных данных.    
- **Неповторяемое чтение** (Non-repeatable Read) — Данные изменились при повторном чтении.    
- **Фантомное чтение** (Phantom Read) — Появились новые строки.    

### **4. Durability** (Долговечность)
**Что значит:**  
	После `COMMIT` изменения **не теряются** (*даже при сбое*).
**Как работает:**
- Данные сначала пишутся в **журнал транзакций** (WAL), затем в БД.    
- При крахе → восстановление из журнала.    

---
### **Когда нарушается ACID?**
1. **NoSQL** (MongoDB, Cassandra) — Часто жертвуют ACID ради скорости.    
2. **Распределенные БД** — Используют **BASE** (Basically Available, Soft state, Eventually consistent).    
3. **Микросервисы** — Транзакции через **Saga** или **2PC**.    

### **Как проверить?**
**Для SQL-БД:**
```sql
SHOW TRANSACTION ISOLATION LEVEL; -- (PostgreSQL)  
SELECT * FROM information_schema.innodb_trx; -- (MySQL)  
```

### **Итог в 1 строку**
**ACID = `Все или ничего` + `Правила` + `Невидимость друг другу` + `Защита от сбоев`.**

| **Свойство** | **Чем обеспечивается?**                |
| ------------ | -------------------------------------- |
| Atomicity    | `WAL` + `Rollback`                     |
| Consistency  | `Ограничения БД`                       |
| Isolation    | Уровни изоляции (`MVCC`, `блокировки`) |
| Durability   | `WAL` + `fsync`                        |

**Мнемоника:** **A**томарность, **C**огласованность, **I**золяция, **D**олговечность → **ACID**.

---
---
---
# **Проблемы <u>параллельной</u> работы с данными**
**(Кратко о главном)**

---
## **1. Основные конфликты**

1. **Потерянное обновление (Lost Update)**    
    - Перезапись изменений другой транзакцией.
    - ПРИМЕР: rase-condition с инкрементом
    
2. **Грязное чтение (Dirty Read)**    
    - Чтение незафиксированных данных.        
    - _Где:_ `Read Uncommitted`.        
    - ПРИМЕР: транзакция не закончилась, а мы УЖЕ прочитали (*мусор*)
	
3. **Неповторяемое чтение (Non-repeatable Read)**    
    - Данные изменились при повторном запросе.        
    - _Где:_ `Read Uncommitted`, `Read Committed`.
    - ПРИМЕР: 1 и та-же строка при повторном чтении -разные результаты
    
4. **Фантомное чтение (Phantom Read)**    
    - Появление новых строк при повторном запросе.        
    - _Где:_ `Read Uncommitted`, `Read Committed`, `Repeatable Read`.
    - ПРИМЕР: Мы сделали выборку, но др. транзакция на лету добавила/ удалаила
    
5. **Взаимная блокировка (Deadlock)**    
    - Циклическая зависимость блокировок.        

---
## **2. Решения**

#### **А. Уровни изоляции**

|Уровень|Dirty Read|Non-repeatable|Phantoms|
|---|---|---|---|
|`Read Uncommitted`|❌|❌|❌|
|`Read Committed`|✅|❌|❌|
|`Repeatable Read`|✅|✅|❌|
|`Serializable`|✅|✅|✅|

#### **Б. Механизмы**
- **MVCC** (версионирование): Чтение «снимка» данных (*PostgreSQL*).    
- **Блокировки:** Пессимистичные (`SELECT FOR UPDATE`) или оптимистичные.    

---
## **3. Оптимистичная vs. Пессимистичная блокировки**

|**Критерий**|**Оптимистичная**|**Пессимистичная**|
|---|---|---|
|**Принцип**|«Проверь при коммите»|«Заблокируй заранее»|
|**Как работает**|Сравнивает версии данных|Блокирует строку/таблицу|
|**Плюсы**|Высокая параллельность|Гарантированная консистентность|
|**Минусы**|Конфликты при частых изменениях|Риск дедлоков|
|**Когда использовать**|Редкие конфликты (чтение >> записи)|Частые изменения (финансовые операции)|

**Оптимистичная:**
```sql
UPDATE table SET data = 'new', version = version + 1 WHERE id = 1 AND version = 2;
```

**Пессимистичная:**
```sql
SELECT * FROM table WHERE id = 1 FOR UPDATE;
```

**Итог:**
- **Оптимистичная** — для сценариев с низкой конкуренцией.    
- **Пессимистичная** — когда критична точность (например, банковские транзакции).

---
