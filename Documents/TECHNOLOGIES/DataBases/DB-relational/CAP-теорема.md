# Шпаргалка по **CAP-теореме**
**Кратко и понятно — для собеседования**

---
## **🔹 Формулировка CAP-теоремы**

**Любая распределённая система может гарантировать только 2 из 3 свойств:**
1. **Consistency** (*Согласованность*)    
    - Все узлы видят **одни и те же данные** в один момент времени.    
2. **Availability** (*Доступность*)    
    - Система **всегда отвечает** (даже при сбоях части узлов).    
3. **Partition Tolerance**  (*Устойчивость к разделению*)   
    - Работает при **разрывах связи** между узлами (*network partition*).        

**Важно:**
- **Partition Tolerance обязательна** в распределённых системах (*сети ненадёжны*).    
- Выбор идёт между **C** и **A** при возникновении сетевого раздела.    

---
## **🔹 Возможные комбинации**

|**Тип системы**|**Consistency**|**Availability**|**Partition Tolerance**|**Примеры**|
|---|---|---|---|---|
|**CA**|✅ Да|✅ Да|❌ Нет|Классические SQL-БД (PostgreSQL в одном дата-центре)|
|**CP**|✅ Да|❌ Нет|✅ Да|MongoDB (в режиме strong consistency), Redis, ZooKeeper|
|**AP**|❌ Нет|✅ Да|✅ Да|Cassandra, DynamoDB, Kafka|

---
## **🔹 Как выбирают между `C` и `A`?**

### **1. CP-системы (`Consistency` + `Partition Tolerance`)**
- **Когда нужно:** Банки, транзакции, системы, где **точность важнее доступности**.    
- **Поведение при разрыве связи:**    
    - Отказывают в записи/чтении (например, возвращают ошибку или ждут восстановления).        
- **Пример:**    
    > «При сетевом разделе ZooKeeper не даст записать данные, чтобы избежать конфликтов».    

### **2. AP-системы (Availability + Partition Tolerance)**
- **Когда нужно:** Соцсети, кэши, системы, где **доступность важнее точности**.    
- **Поведение при разрыве связи:**    
    - Разрешают чтение/запись, но возможны **конфликты** (позже разрешаются через **eventual consistency**).    
- **Пример:**    
    > «Cassandra позволит записать данные в любой узел, даже если часть кластера недоступна».    

---
## **🔹 Важные уточнения**
1. **CAP — не про обычную работу**, а только про **режим сетевого раздела**.    
2. **BASE ≠ AP** (BASE — это философия, AP — свойство в CAP).    
3. **На практике:**    
    - Системы могут **менять режим** (например, MongoDB: strong consistency → eventual consistency).        
    - Есть **гибридные подходы** (например, «согласованность с кворумом»: `R + W > N`).        

---
## **🔹 Как отвечать на собесе?**
**Коротко:**
> «CAP-теорема говорит, что при разрыве сети распределённая система жертвует либо согласованностью (AP), либо доступностью (CP). Например, банки выбирают CP, а соцсети — AP».

**Технически:**
> «В DynamoDB при сетевом разделе вы можете выбрать:> 
> - **Strong consistency** (CP, ждём ответа от всех узлов),>     
> - **Eventual consistency** (AP, читаем из ближайшего узла)».>     

---
## **🔹 Что запомнить?**

1. **Partition Tolerance неизбежна** в распределённых системах.    
2. **CP** — данные точны, но система может «лечь».    
3. **AP** — система работает, но данные могут быть неактуальны.    
4. **CA** — только для нераспределённых систем (один сервер/дата-центр).    

**Итог:**  
CAP помогает понять **компромиссы** при проектировании распределённых систем. Главное — чётко объяснить, что выбор между C и A происходит **только при сетевом разделе**.

---
**Пример вопроса на собесе:**  
_«Как бы вы спроектировали систему платежей с учётом CAP?»_  

**Ответ:**
> «Выбрал бы CP: согласованность критична, даже если это временно снизит доступность. Например, использовал бы кворумную запись (W > N/2)».

---
