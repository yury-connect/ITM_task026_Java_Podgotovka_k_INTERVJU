# –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –ø—Ä–æ–±–ª–µ–º—É N+1 Select –∏ –ø—É—Ç—è—Ö –µ–µ —Ä–µ—à–µ–Ω–∏—è.

---
## üê¢ –ü—Ä–æ–±–ª–µ–º–∞ N+1 Select –≤ Hibernate

### ‚ùóÔ∏è –í —á—ë–º —Å—É—Ç—å?
üëâ¬†**–ü—Ä–æ–±–ª–µ–º–∞ N+1 –≤–æ–∑–Ω–∏–∫–∞–µ—Ç**, –∫–æ–≥–¥–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π (_–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø–æ—Å—Ç—ã_)¬†`Hibernate`¬†–≤—ã–ø–æ–ª–Ω—è–µ—Ç¬†**1 –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å –∏ N –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö**¬†–¥–ª—è –∫–∞–∂–¥–æ–π —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏.

üîé –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫¬†**—Å–∏–ª—å–Ω–æ–º—É –ø–∞–¥–µ–Ω–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä—ë–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.

---
### üõ† –ü—É—Ç–∏ —Ä–µ—à–µ–Ω–∏—è

|**‚Ññ**|üîß¬†**–ü–æ–¥—Ö–æ–¥**|üìã¬†**–û–ø–∏—Å–∞–Ω–∏–µ**|
|---|---|---|
|1Ô∏è‚É£|üîó¬†**JOIN FETCH**|–ò—Å–ø–æ–ª—å–∑—É–µ—Ç¬†`JOIN FETCH`¬†–≤ JPQL –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π¬†**–≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.**// –∞–≥–∞–ª–æ–≥ EAGER –∑–∞–≥—Ä—É–∑–∫–∏. –í—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏ —Å—Ä–∞–∑—É.  <br>–ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–≤—è–∑–µ–π –∏ 1‚Äì3 —É—Ä–æ–≤–Ω–µ–π –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏.|
|2Ô∏è‚É£|üì¶¬†**@Fetch**¬†(`FetchMode.SUBSELECT`)|–†–∞–±–æ—Ç–∞–µ—Ç¬†**—Ç–æ–ª—å–∫–æ —Å –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏**.  <br>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è¬†**1**¬†–∑–∞–ø—Ä–æ—Å –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–µ–π –∏¬†**1**¬†–ø–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–π¬†_(–≤ –æ—Ç–ª–∏—á–∏–∏ –æ—Ç¬†`JOIN FETCH`)_.  <br>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω—É–∂–Ω—ã¬†**–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.**|
|3Ô∏è‚É£|üß†¬†**EntityGraph**|–ü–æ–∑–≤–æ–ª—è–µ—Ç¬†**–≤—Ä—É—á–Ω—É—é**¬†–æ–ø–∏—Å–∞—Ç—å –≥—Ä–∞—Ñ —Å—É—â–Ω–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å. –î–ª—è –∫–∞–∂–¥–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –æ–ø–∏—Å–∞—Ç—å —Å–≤–æ–π¬†`EntityGraph`.  <br>–•–æ—Ä–æ—à –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –∏ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö.|
|4Ô∏è‚É£|üìö¬†**Batch Fetching**|–£–∫–∞–∑—ã–≤–∞–µ—Ç¬†`Hibernate`, —Å–∫–æ–ª—å–∫–æ —Å—É—â–Ω–æ—Å—Ç–µ–π –∑–∞–≥—Ä—É–∂–∞—Ç—å –∑–∞ —Ä–∞–∑// –æ–¥–Ω–æ–º–æ–º–µ–Ω—Ç–Ω–æ.  <br>–ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ª–µ–Ω–∏–≤—ã–º –∫–æ–ª–ª–µ–∫—Ü–∏—è–º –≤¬†**–º–µ–Ω—å—à–µ–µ —á–∏—Å–ª–æ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤.**  <br>–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è:¬†`@BatchSize(size = N)`|
|5Ô∏è‚É£|üìù¬†**SqlResultSetMapping / HibernateSpecificMapping**|–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å¬†**–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ SQL-–∑–∞–ø—Ä–æ—Å–∞–º–∏**.  <br>–ü–æ–∑–≤–æ–ª—è—é—Ç —è–≤–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Å—É—â–Ω–æ—Å—Ç–µ–π –∏ –∏—Ö –º–∞–ø–ø–∏–Ω–≥.|
|üí°|üßæ¬†**DTO + Custom Queries**|–í —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å¬†**DTO**¬†(_Data Transfer Object_) –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.  <br>–û—Å–æ–±–µ–Ω–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–∏ REST API –∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö.|

---
### üí° –†–µ–∑—é–º–µ
> üî• –ü—Ä–æ–±–ª–µ–º–∞¬†`N+1`¬†‚Äî –æ–¥–Ω–∞ –∏–∑¬†**—Å–∞–º—ã—Ö —á–∞—Å—Ç—ã—Ö**¬†–ø—Ä–∏—á–∏–Ω –º–µ–¥–ª–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã¬†_ORM_.  
> ‚úÖ –õ—É—á—à–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:
> 
> - **`JOIN FETCH`**¬†‚Äî –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤.
> - `EntityGraph`¬†‚Äî –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫.
> - DTO + –Ω–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã ‚Äî –∫–æ–≥–¥–∞ –≤–∞–∂–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å.

---

```
***** –∏–∑ –º–µ—Ç–æ–¥–∏—á–∫–∏ *****
–ü—Ä–æ–±–ª–µ–º–∞ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ N –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö 
SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ—Ö –∂–µ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å –ø–æ–ª—É—á–µ–Ω—ã –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ SQL-–∑–∞–ø—Ä–æ—Å–∞.

1.        JOIN FETCH
–ò –ø—Ä–∏ FetchType.EAGER –∏ –ø—Ä–∏ FetchType.LAZY –Ω–∞–º –ø–æ–º–æ–∂–µ—Ç JPQL-–∑–∞–ø—Ä–æ—Å —Å JOIN FETCH. 
–û–ø—Ü–∏—é ¬´FETCH¬ª –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ JOIN (INNER JOIN –∏–ª–∏ LEFT JOIN) –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ 
–≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –≤–º–µ—Å—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ª–µ–Ω–∏–≤—ã–º –ø–æ–ª—è–º –æ–±—ä–µ–∫—Ç–∞.
–õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (1-3 —É—Ä–æ–≤–Ω—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤).
  select pc
      from PostComment pc
      join fetch pc.post p
        
2.        EntityGraph
–í —Å–ª—É—á–∞—è—Ö, –∫–æ–≥–¥–∞ –Ω–∞–º –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö, 
–∏ —É –Ω–∞—Å jpql –∑–∞–ø—Ä–æ—Å - –ª—É—á—à–µ –≤—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å EntityGraph.

3.        @Fetch(FetchMode.SUBSELECT)
–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è Hibernate. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏. 
–ë—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω –æ–¥–∏–Ω sql-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ—Ä–Ω–µ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –∏, –µ—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ 
–±—É–¥–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ª–µ–Ω–∏–≤—ã–º –ø–æ–ª—è–º-–∫–æ–ª–ª–µ–∫—Ü–∏—è–º, —Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –µ—â–µ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π:
  @Fetch(value = FetchMode.SUBSELECT)
      private Set<Order> orders = new HashSet<>();
        
4.        Batch fetching
–≠—Ç–æ –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è Hibernate, –≤ JPA –µ—ë –Ω–µ—Ç. –£–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞–¥ –∫–ª–∞—Å—Å–æ–º —Å—É—â–Ω–æ—Å—Ç–∏ 
–∏–ª–∏ –Ω–∞–¥ –ø–æ–ª–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π. –ë—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω –æ–¥–∏–Ω sql-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ—Ä–Ω–µ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π 
–∏, –µ—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –±—É–¥–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ª–µ–Ω–∏–≤—ã–º –ø–æ–ª—è–º-–∫–æ–ª–ª–µ–∫—Ü–∏—è–º, —Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –µ—â–µ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å 
–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏.
  @BatchSize(size=5)
  private Set<Order> orders = new HashSet<>();

–•–æ—Ç—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å @BatchSize –ª—É—á—à–µ, —á–µ–º —Å—Ç–æ–ª–∫–Ω—É—Ç—å—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π –∑–∞–ø—Ä–æ—Å–∞ N+1, –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ 
–≥–æ—Ä–∞–∑–¥–æ –ª—É—á—à–µ–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–æ–π —è–≤–ª—è–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DTO –∏–ª–∏ JOIN FETCH, –ø–æ—Å–∫–æ–ª—å–∫—É 
–æ–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –ø–æ–ª—É—á–∞—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º.

5.        HibernateSpecificMapping, SqlResultSetMapping
–î–ª—è –Ω–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ –∏—Ö.

```

---
